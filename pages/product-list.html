<style>
  .product-item {
    display: flex;
    justify-content: space-between;
    padding: 16px 0px 16px 0px;
  }
  .product-item > a {
    background-color: none;
    color: blue;
    cursor: pointer;
  }
</style>
<h1 i18n="page.productList"></h1>
<button onclick="uiOpenCreateProduct()">New product</button>
<ul id="products">
</ul>

<script type="text/javascript">
addTranslations({
  page: {
    productList: "Todos produtos"
  },
  prompts: {
    reallyDelete: "Ta certa para excluído {name}?"
  },
  buttons: {
    create: 'Crair'
  },
  snackbars: {
    productRemoved: "O produto {name} foi excluído",
    productAdded: "O produto {name} foi criado.",
    productNameInvalid: "Digite um nome valido."
  },
});
</script>

<script type="text/javascript">
async function uiRefresh() {
  const productsContainer = document.getElementById("products");
  const products = await listProducts();
  productsContainer.innerHTML = "";
  products.forEach((product) => productsContainer.appendChild(uiProductListItem({id: product.id, ...product.data()})));
}

async function uiDelete(id, name) {
  await removeProduct(id);
  Sheet.collapse();
  setTimeout(() => Sheet.hide(), 300);
  Snackbar.open(translate("snackbars.productRemoved", {name}));
  await uiRefresh();
}

async function uiBuildConfirm(id, name) {
  return h('div', {}, [translate('prompts.reallyDelete', {name}), h('button', {onclick: `uiDelete('${id}', '${name}')`}, ['Sím'])]);
}

async function uiPromptDelete(id, name) {
  const c = await uiBuildConfirm(id, name);
  Sheet.render(c);
  Sheet.show();
  setTimeout(() => Sheet.draw(), 10);
}

/**
 * @param {Product} product
 */
function uiProductListItem(product) {
  return h('li', {class: "product-item", productName: product.name}, [
    product.name,
    h('a', {onclick: 'uiPromptDelete("' + product.id + '", "' + product.name + '")'}, ["Excludío"])
  ]);
}

async function uiOpenCreateProduct() {
  const component = h('div', {}, [h('form', {action: '#', onsubmit: "uiAddProduct(event)"}, [
    h('input', {type: 'text', id: 'product-name'}, []),
    h('input', {type: 'submit'}, [translate('buttons.create')])
  ])]);
  Sheet.render(component);
  Sheet.expand();
  Sheet.show();
}

async function uiAddProduct(e) {
  e.preventDefault();
  const productName = document.getElementById("product-name");
  try {
    const product = newProduct(productName.value);
    await storeProduct(product);
    productName.value = "";
    Snackbar.open(translate("snackbars.productAdded", {name: product.name}));
    await uiRefresh();
    Sheet.collapse();
    Sheet.hide();
  } catch(e) {
    if (e === ProductNameIsInvalid)
      Snackbar.open(translate("snackbars.productNameInvalid"), undefined, SNACKBAR_ERROR);
    else
      Snackbar.open(e.message, 5000, SNACKBAR_ERROR);
  }
}

uiRefresh();

</script>
